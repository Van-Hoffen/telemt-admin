# AGENTS.md

Руководство для AI-агентов и разработчиков проекта `telemt-admin`.

## 1) Что это за проект

- `telemt-admin` — Telegram-бот для администрирования доступа к `telemt` (MTProto proxy).
- Основные сценарии:
  - регистрация пользователя по invite-токену;
  - ручное или автоматическое одобрение;
  - выдача proxy-ссылки и QR;
  - управление пользователями и `systemd`-сервисом.

## 2) Технологический стек

- Rust edition `2024`
- Telegram API: `teloxide`
- База данных: `SQLite` через `sqlx`
- Конфиг telemt: `toml` + `toml_edit`
- Логирование: `tracing`, `tracing-subscriber`

## 3) Структура кода

- `src/main.rs` — инициализация конфига, БД, состояния бота и `Dispatcher`.
- `src/config.rs` — загрузка `telemt-admin.toml`, дефолты и проверка токена бота.
- `src/db.rs` — слой данных:
  - заявки (`registration_requests`);
  - invite-токены (`invite_tokens`);
  - миграции/эволюция схемы.
- `src/telemt_cfg.rs` — чтение/изменение `telemt.toml`, атомарная запись.
- `src/service.rs` — обертка над `systemctl`.
- `src/link.rs` — генерация секрета и `tg://proxy`-ссылки.
- `src/bot/handlers.rs` — основная бизнес-логика и обработчики команд/callback.
- `src/bot/keyboards.rs` — inline/reply клавиатуры.

## 4) Ключевые инварианты (не ломать)

- После изменения `telemt`-конфига нужен `restart` сервиса (не полагаться на hot-reload).
- Пользователь `telemt` маппится как `tg_<telegram_user_id>`.
- Invite-токен учитывает:
  - срок действия;
  - признак `is_active`;
  - лимит использования (`max_usage`).
- Ошибки и тексты для пользователей/админов преимущественно на русском языке.
- Логи и сообщения должны оставаться информативными (с `tracing` и контекстом).

## 5) Правила изменений

- Вносить минимально необходимые изменения без лишних рефакторингов.
- Сохранять текущую модульную границу:
  - Telegram/UI-логика в `handlers`/`keyboards`;
  - БД-операции в `db`;
  - работу с `telemt.toml` в `telemt_cfg`;
  - systemd-операции в `service`.
- При добавлении новых callback-путей:
  - валидировать payload;
  - обрабатывать ошибки парсинга без panic;
  - отвечать пользователю безопасным текстом.
- Не добавлять новые зависимости без явной необходимости.
- Не изменять формат существующих пользовательских команд без причины.

## 6) Команды для локальной проверки

Перед завершением заметных изменений запускать:

```bash
cargo check --locked
cargo clippy --all-targets -- -D warnings
```

Если менялись зависимости:

```bash
cargo check
```

## 7) CI/CD и релизы

- CI (`.github/workflows/ci.yml`) проверяет:
  - `cargo check --locked`
  - `cargo clippy --all-targets -- -D warnings`
- Релиз (`.github/workflows/release.yml`) собирает артефакты для Linux/Windows по тегам `v*.*.*`.
- Changelog формируется через `git-cliff` с Conventional Commits (`cliff.toml`).

## 8) Конвенции коммитов

Предпочтительный стиль: Conventional Commits (`feat:`, `fix:`, `refactor:`, `docs:` и т.д.), чтобы релиз-ноты группировались корректно.

## 9) Чего избегать

- Не использовать `unwrap()` там, где ошибка может быть штатной/внешней.
- Не смешивать инфраструктурные изменения (systemd/telemt cfg/DB) в одном большом неатомарном блоке без логов и обработки ошибок.
- Не писать тесты и новые тестовые каркасы без явного запроса.
- Не использовать God Variables, все константы выносить в настройки.
- Избегать выстрела дробью и других подобных антипаттернов.

## 10) Подсказка по безопасной доработке фич

Для любой новой административной команды:

1. Проверить права (`is_admin_message`).
2. Провалидировать входные аргументы.
3. Выполнить доменную операцию в соответствующем модуле (`db`/`telemt_cfg`/`service`).
4. Логировать результат через `tracing`.
5. Отправить понятный ответ в чат.
